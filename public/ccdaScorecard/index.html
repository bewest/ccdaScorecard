<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>SMART C-CDA Scorecard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Le styles -->
<link href="/static/bootstrap/css/bootstrap.css" rel="stylesheet">
<script src="/static/bootstrap/js/jquery.js"></script>
<script src="/static/js/Markdown.Converter.js"></script>

<style type="text/css">
body {
  padding-top: 60px;
  overflow-y: scroll;
}
#pasteHere {
  width: 100%
}
.comparison {margin-bottom: 20px;}
.grade {margin-right: 10px;}
#exampleHolder {
  display: none;
}

#feedbackSection {
  display: none;
}

</style>
<link href="/static/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
</head>

<body>
<div class="container">
  <div class="navbar navbar navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <a class="brand" href="#">SMART C-CDA Scorecard</a>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Main hero unit for a primary marketing message or call to action -->
    <div class="hero-unit">
      <h1>Your C-CDA.  Beautiful.</h1>
    </div>

    <!-- Example row of columns -->
    <div class="row">
      <div class="span12">
        <h2>Paste and go.</h2>
        <textarea id="exampleHolder" placeholder="Your C-CDA here"></textarea>
        <textarea AUTOFOCUS id="pasteHere" placeholder="Your C-CDA here"></textarea><br>
        <button DISABLED id="scoreMe" class="btn">Score me!</button>
        <button DISABLED id="example" class="btn">Show me an example</button> <span id='loading'>loading...</span>
      </div>
    </div>

    <div id="feedbackSection" class="row">
      <div class="span12">
        <h2>Your scorecard</h2>
        <div id="scoring">Scoring...</div>
        <div id="scorecard">

        </div>
      </div>
    </div>
  </div> <!-- /container -->
</div>
<div class="container">
  <hr>
  <footer>
    <p>&copy; Harvard Medical School / Boston Children's Hospital, 2013. Source <a href="https://github.com/chb/ccdaScorecard">on GitHub</a>.</p>
  </footer>
</div>

<!-- Le javascript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="/static/bootstrap/js/bootstrap-transition.js"></script>
<script src="/static/bootstrap/js/bootstrap-alert.js"></script>
<script src="/static/bootstrap/js/bootstrap-modal.js"></script>
<script src="/static/bootstrap/js/bootstrap-dropdown.js"></script>
<script src="/static/bootstrap/js/bootstrap-scrollspy.js"></script>
<script src="/static/bootstrap/js/bootstrap-tab.js"></script>
<script src="/static/bootstrap/js/bootstrap-tooltip.js"></script>
<script src="/static/bootstrap/js/bootstrap-popover.js"></script>
<script src="/static/bootstrap/js/bootstrap-button.js"></script>
<script src="/static/bootstrap/js/bootstrap-collapse.js"></script>
<script src="/static/bootstrap/js/bootstrap-carousel.js"></script>
<script src="/static/bootstrap/js/bootstrap-typeahead.js"></script>
<script>
$(function(){

  var stats = $.ajax({ url: "/v1/ccda-scorecard/stats" });
  var rubrics = $.ajax({ url: "/v1/ccda-scorecard/rubrics" });
  var example = $.ajax({ url: "./example.ccda.xml", dataType: "text"});
  var renderMarkdown = new Markdown.Converter().makeHtml; 

  $.when(stats, rubrics, example).then(function(s, r, e){
    stats = s[0];
    rubrics = r[0];

    // not round-trippable by default
    // so round-trip it once to comparability
    $("#exampleHolder").val(e[0].trim());
    example = $("#exampleHolder").val();

    $("#loading").hide();
    $("button").removeAttr("disabled");
  });

  
  $("#example").click(function(){
    $("#pasteHere").val(example);
    $("#scoreMe").click();
  });


  $("#scoreMe").click(function(){

    $("#feedbackSection").show();
    $("#scoring").show();
    
    var content = $("#pasteHere").val().trim();
    console.log("Requesting score for ", content.length);

    var exampleFlag = "";
    if (content === example){
      exampleFlag = "?example=true"; 
    }

    $.ajax({
      type: "post",
      url: "/v1/ccda-scorecard/request"+exampleFlag, 
      data: content
    }).success(function(scores){
      $("#scoring").hide();
      $("#scorecard").html("");
      scores.forEach(function(s){
        $("#scorecard").append(makeScore(s)); 
      });
    });
  });

  function makeScore(s){
    console.log("one score", s);

    var rubric = rubrics[s.rubric];
    var peers = stats[s.rubric];

    ret = "<div>" + 
      "<span class='badge grade'>" + s.grade + " </span><b>" + s.rubric + "</b>"+
      "<div><b>"+s.rubric+"</b>: " + rubric.description + " </div>" + 
      "<div><b>Best practice</b>: " + rubric.bestPractice + " </div>";

      // extra report details rendered in Markdown
      if (s.details) {
        ret += renderMarkdown(s.details);
      }

      if (peers) {
      ret += "<div class='comparison'><small>How does your document stack up?: "  + 
      Object.keys(peers.counts).map(function(c){
      return c+": " + peers.counts[c] + " documents";
    }).join(", ") + 
      "</small></div>";
      }
      ret += "</div>";

    console.log(ret)
    return $(ret);

  };
});
</script>
</body>
</html>
